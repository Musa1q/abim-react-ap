const express = require('express');
const mysql = require('mysql2/promise');
const bcrypt = require('bcryptjs');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 5000;

// Middleware
app.use(cors());
app.use(express.json());

// Multer konfig√ºrasyonu
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/courses/');
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB limit
  },
  fileFilter: (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|webp/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);
    
    if (mimetype && extname) {
      return cb(null, true);
    } else {
      cb(new Error('Sadece JPEG, PNG ve WEBP formatlarƒ± desteklenir.'));
    }
  }
});

// Static dosya servisi
app.use('/uploads', express.static('uploads'));

// Veritabanƒ± baƒülantƒ±sƒ±
const dbConfig = {
  host: 'localhost',
  user: 'root',
  password: '', // XAMPP'te genellikle bo≈ü
  database: 'abim_react_db',
  port: 3306,
  charset: 'utf8mb4'
};

// Baƒülantƒ± havuzu
const pool = mysql.createPool({
  ...dbConfig,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
});

// Baƒülantƒ± testi ve tablo olu≈üturma
const testConnection = async () => {
  try {
    const connection = await pool.getConnection();
    console.log('‚úÖ Veritabanƒ± baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!');
    
    // Activities tablosunu olu≈ütur
    await createActivitiesTable();
    
    // Mevcut tablolarƒ± kontrol et
    try {
      const [tables] = await connection.execute("SHOW TABLES");
      console.log('üìã Mevcut tablolar:', tables.map(t => Object.values(t)[0]));
      
      // course_applications tablosu var mƒ± kontrol et
      const hasCourseApplications = tables.some(t => Object.values(t)[0] === 'course_applications');
      console.log('üìã course_applications tablosu var mƒ±?', hasCourseApplications);
      
      if (!hasCourseApplications) {
        console.log('üî® course_applications tablosu olu≈üturuluyor...');
        await connection.execute(`
          CREATE TABLE course_applications (
            id INT AUTO_INCREMENT PRIMARY KEY,
            course_id INT NOT NULL,
            student_name VARCHAR(255) NOT NULL,
            student_email VARCHAR(255) NOT NULL,
            student_phone VARCHAR(20),
            message TEXT,
            status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
          )
        `);
        console.log('‚úÖ course_applications tablosu olu≈üturuldu!');
      } else {
        console.log('‚úÖ course_applications tablosu zaten mevcut!');
        
        // Mevcut tablonun yapƒ±sƒ±nƒ± kontrol et
        try {
          const [columns] = await connection.execute("DESCRIBE course_applications");
          console.log('üìã course_applications tablo yapƒ±sƒ±:', columns.map(col => col.Field));
          
          // Eksik s√ºtunlarƒ± kontrol et ve ekle
          const columnNames = columns.map(col => col.Field);
          const requiredColumns = ['student_name', 'student_email', 'student_phone', 'message', 'status', 'updated_at'];
          
          for (const col of requiredColumns) {
            if (!columnNames.includes(col)) {
              console.log(`üî® Eksik s√ºtun ekleniyor: ${col}`);
              let alterQuery = '';
              switch (col) {
                case 'student_name':
                  alterQuery = 'ALTER TABLE course_applications ADD COLUMN student_name VARCHAR(255) NOT NULL';
                  break;
                case 'student_email':
                  alterQuery = 'ALTER TABLE course_applications ADD COLUMN student_email VARCHAR(255) NOT NULL';
                  break;
                case 'student_phone':
                  alterQuery = 'ALTER TABLE course_applications ADD COLUMN student_phone VARCHAR(20)';
                  break;
                case 'message':
                  alterQuery = 'ALTER TABLE course_applications ADD COLUMN message TEXT';
                  break;
                case 'status':
                  alterQuery = "ALTER TABLE course_applications ADD COLUMN status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending'";
                  break;
                case 'updated_at':
                  alterQuery = 'ALTER TABLE course_applications ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP';
                  break;
              }
              if (alterQuery) {
                await connection.execute(alterQuery);
                console.log(`‚úÖ ${col} s√ºtunu eklendi!`);
              }
            }
          }
        } catch (error) {
          console.error('‚ùå Tablo yapƒ±sƒ± kontrol hatasƒ±:', error);
        }
      }
    } catch (error) {
      console.error('‚ùå Tablo i≈ülemleri hatasƒ±:', error);
    }
    
    connection.release();
    return true;
  } catch (error) {
    console.error('‚ùå Veritabanƒ± baƒülantƒ± hatasƒ±:', error.message);
    return false;
  }
};

// API Routes

// Resim y√ºkleme endpoint'i
app.post('/api/upload', upload.single('image'), (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ 
        success: false, 
        message: 'Resim dosyasƒ± bulunamadƒ±' 
      });
    }

    const imageUrl = `http://localhost:${PORT}/uploads/courses/${req.file.filename}`;
    
    res.json({
      success: true,
      imageUrl: imageUrl,
      filename: req.file.filename
    });
  } catch (error) {
    console.error('Resim y√ºkleme hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Resim y√ºklenirken bir hata olu≈ütu' 
    });
  }
});

// Giri≈ü endpoint'i
app.post('/api/login', async (req, res) => {
  try {
    const { email, password } = req.body;

    // Veritabanƒ±ndan kullanƒ±cƒ±yƒ± bul
    const [rows] = await pool.execute(
      'SELECT * FROM users WHERE email = ? AND is_active = 1',
      [email]
    );

    if (rows.length === 0) {
      return res.status(401).json({ 
        success: false, 
        message: 'E-posta veya ≈üifre hatalƒ±' 
      });
    }

    const user = rows[0];

    // ≈ûifre kontrol√º
    const isPasswordValid = await bcrypt.compare(password, user.password);
    
    if (!isPasswordValid) {
      return res.status(401).json({ 
        success: false, 
        message: 'E-posta veya ≈üifre hatalƒ±' 
      });
    }

    // Son giri≈ü tarihini g√ºncelle
    await pool.execute(
      'UPDATE users SET last_login = NOW() WHERE id = ?',
      [user.id]
    );

    res.json({
      success: true,
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role,
        uid: user.id.toString(),
        displayName: user.name
      }
    });

  } catch (error) {
    console.error('Giri≈ü hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Sunucu hatasƒ±' 
    });
  }
});

// Kurslar endpoint'i
app.get('/api/courses', async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT * FROM courses WHERE is_active = 1 AND egitim_baslangic <= CURDATE() AND egitim_bitis >= CURDATE() ORDER BY created_at DESC');
    
    // JSON alanlarƒ±nƒ± parse et
    const courses = rows.map(course => ({
      ...course,
      dersGunleri: JSON.parse(course.ders_gunleri),
      mufredat: course.mufredat ? JSON.parse(course.mufredat) : [],
      // Time formatƒ±nƒ± d√ºzelt (HH:MM:SS -> HH:MM)
      dersSaati: course.ders_saati ? course.ders_saati.substring(0, 5) : '',
      // Frontend ile uyumlu hale getir
      mainTitle: course.main_title,
      subtitle: course.subtitle,
      imageUrl: course.image_url,
      content: {
        egitimSuresi: [
          { "Ba≈ülangƒ±√ß": course.egitim_baslangic },
          { "Biti≈ü": course.egitim_bitis }
        ],
        mufredat: course.mufredat ? JSON.parse(course.mufredat) : []
      }
    }));

    res.json({ success: true, courses });
  } catch (error) {
    console.error('Kurslar hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Sunucu hatasƒ±' });
  }
});

// Tek kurs endpoint'i
app.get('/api/courses/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    const [rows] = await pool.execute(
      'SELECT *, DATE_FORMAT(egitim_baslangic, "%Y-%m-%d") as egitim_baslangic_str, DATE_FORMAT(egitim_bitis, "%Y-%m-%d") as egitim_bitis_str FROM courses WHERE id = ? AND is_active = 1',
      [id]
    );

    if (rows.length === 0) {
      return res.status(404).json({ success: false, message: "Kurs bulunamadƒ±" });
    }

    const course = {
      ...rows[0],
      dersGunleri: JSON.parse(rows[0].ders_gunleri),
      mufredat: rows[0].mufredat ? JSON.parse(rows[0].mufredat) : [],
      // Time formatƒ±nƒ± d√ºzelt (HH:MM:SS -> HH:MM)
      dersSaati: rows[0].ders_saati ? rows[0].ders_saati.substring(0, 5) : '',
      // Frontend ile uyumlu hale getir
      mainTitle: rows[0].main_title,
      subtitle: rows[0].subtitle,
      imageUrl: rows[0].image_url,
      content: {
        egitimSuresi: [
          { "Ba≈ülangƒ±√ß": rows[0].egitim_baslangic_str || "" },
          { "Biti≈ü": rows[0].egitim_bitis_str || "" }
        ],
        mufredat: rows[0].mufredat ? JSON.parse(rows[0].mufredat) : []
      }
    };

    res.json({
      success: true,
      course
    });

  } catch (error) {
    console.error('Kurs getirme hatasƒ±:', error);
    res.status(500).json({ success: false, message: "Kurs y√ºklenirken bir hata olu≈ütu" });
  }
});

// Kurs ekleme endpoint'i
app.post('/api/courses', async (req, res) => {
  try {
    const { mainTitle, subtitle, imageUrl, dersGunleri, dersSaati, content } = req.body;
    
    // Veritabanƒ±na kaydet
    const [result] = await pool.execute(
      `INSERT INTO courses (main_title, subtitle, image_url, ders_gunleri, ders_saati, egitim_baslangic, egitim_bitis, mufredat) 
       VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        mainTitle,
        subtitle,
        imageUrl,
        JSON.stringify(dersGunleri),
        dersSaati + ':00', // HH:MM -> HH:MM:SS
        content.egitimSuresi[0]["Ba≈ülangƒ±√ß"],
        content.egitimSuresi[1]["Biti≈ü"],
        JSON.stringify(content.mufredat)
      ]
    );

    // Aktivite kaydet
    await logCourseCreated(mainTitle);

    res.json({
      success: true,
      course: { id: result.insertId }
    });

  } catch (error) {
    console.error('Kurs ekleme hatasƒ±:', error);
    res.status(500).json({ success: false, message: "Kurs eklenirken bir hata olu≈ütu" });
  }
});

       // Kurs g√ºncelleme endpoint'i
       app.put('/api/courses/:id', async (req, res) => {
         try {
           const { id } = req.params;
           const { mainTitle, subtitle, imageUrl, dersGunleri, dersSaati, content, isActive } = req.body;
           
           // Eƒüer sadece isActive g√ºncelleniyorsa
           if (isActive !== undefined && mainTitle === undefined && subtitle === undefined && imageUrl === undefined && dersGunleri === undefined && dersSaati === undefined && content === undefined) {
             await pool.execute(
               'UPDATE courses SET is_active = ?, updated_at = NOW() WHERE id = ?',
               [isActive, id]
             );
           } else {
             // Normal g√ºncelleme - mevcut verileri koru
             const [existing] = await pool.execute('SELECT * FROM courses WHERE id = ?', [id]);
             const current = existing[0];
             
             await pool.execute(
               `UPDATE courses SET 
                main_title = ?, subtitle = ?, image_url = ?, ders_gunleri = ?, ders_saati = ?, 
                egitim_baslangic = ?, egitim_bitis = ?, mufredat = ?, is_active = ?, updated_at = NOW()
                WHERE id = ?`,
               [
                 mainTitle || current.main_title,
                 subtitle || current.subtitle,
                 imageUrl || current.image_url,
                 dersGunleri ? JSON.stringify(dersGunleri) : current.ders_gunleri,
                 dersSaati ? dersSaati + ':00' : current.ders_saati,
                 content?.egitimSuresi?.[0]?.["Ba≈ülangƒ±√ß"] || current.egitim_baslangic,
                 content?.egitimSuresi?.[1]?.["Biti≈ü"] || current.egitim_bitis,
                 content?.mufredat ? JSON.stringify(content.mufredat) : current.mufredat,
                 isActive !== undefined ? isActive : current.is_active,
                 id
               ]
             );
           }

           // Aktivite kaydet - g√ºncellenen kurs adƒ±nƒ± al
           const [updatedCourse] = await pool.execute('SELECT main_title FROM courses WHERE id = ?', [id]);
           if (updatedCourse.length > 0) {
             await logCourseUpdated(updatedCourse[0].main_title);
           }

    res.json({
      success: true,
      message: "Kurs ba≈üarƒ±yla g√ºncellendi"
    });

  } catch (error) {
    console.error('Kurs g√ºncelleme hatasƒ±:', error);
    res.status(500).json({ success: false, message: "Kurs g√ºncellenirken bir hata olu≈ütu" });
  }
});

// Kurs silme endpoint'i
app.delete('/api/courses/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    await pool.execute(
      'UPDATE courses SET is_active = 0 WHERE id = ?',
      [id]
    );

    res.json({
      success: true,
      message: "Kurs ba≈üarƒ±yla silindi"
    });

  } catch (error) {
    console.error('Kurs silme hatasƒ±:', error);
    res.status(500).json({ success: false, message: "Kurs silinirken bir hata olu≈ütu" });
  }
});

// Blog yazƒ±larƒ± endpoint'i
app.get('/api/blogs', async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT * FROM blogs ORDER BY created_at DESC');
    res.json({ success: true, data: rows });
  } catch (error) {
    console.error('Blog hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Sunucu hatasƒ±' });
  }
});

// Tek blog endpoint'i
app.get('/api/blogs/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const [rows] = await pool.execute('SELECT * FROM blogs WHERE id = ?', [id]);
    
    if (rows.length === 0) {
      return res.status(404).json({ success: false, message: "Blog bulunamadƒ±" });
    }
    
    res.json({ success: true, data: rows[0] });
  } catch (error) {
    console.error('Blog hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Sunucu hatasƒ±' });
  }
});

// Blog ekleme endpoint'i
app.post('/api/blogs', async (req, res) => {
  try {
    const { title, content, summary, author, category, imageUrl, readTime } = req.body;
    
    const [result] = await pool.execute(
      'INSERT INTO blogs (title, content, summary, author, category, image_url, read_time, is_published, published_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, NOW())',
      [title, content, summary, author, category, imageUrl, readTime, true]
    );
    
    // Aktivite kaydet
    await logBlogPublished(title);
    
    res.json({
      success: true,
      message: "Blog ba≈üarƒ±yla eklendi",
      id: result.insertId
    });
  } catch (error) {
    console.error('Blog ekleme hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Blog eklenirken bir hata olu≈ütu' });
  }
});

// Blog g√ºncelleme endpoint'i
app.put('/api/blogs/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { title, content, summary, author, category, imageUrl, readTime } = req.body;
    
    await pool.execute(
      'UPDATE blogs SET title = ?, content = ?, summary = ?, author = ?, category = ?, image_url = ?, read_time = ?, updated_at = NOW() WHERE id = ?',
      [title, content, summary, author, category, imageUrl, readTime, id]
    );
    
    // Aktivite kaydet - g√ºncelleme
    await logBlogUpdated(title);
    
    res.json({
      success: true,
      message: "Blog ba≈üarƒ±yla g√ºncellendi"
    });
  } catch (error) {
    console.error('Blog g√ºncelleme hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Blog g√ºncellenirken bir hata olu≈ütu' });
  }
});

// Blog silme endpoint'i
app.delete('/api/blogs/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    await pool.execute('DELETE FROM blogs WHERE id = ?', [id]);
    
    res.json({
      success: true,
      message: "Blog ba≈üarƒ±yla silindi"
    });
  } catch (error) {
    console.error('Blog silme hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Blog silinirken bir hata olu≈ütu' });
  }
});

// T√ºm kurslar endpoint'i (admin i√ßin)
app.get('/api/admin/courses', async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT * FROM courses WHERE is_active = 1 ORDER BY created_at DESC');
    
    // JSON alanlarƒ±nƒ± parse et
    const courses = rows.map(course => ({
      ...course,
      dersGunleri: JSON.parse(course.ders_gunleri),
      mufredat: course.mufredat ? JSON.parse(course.mufredat) : [],
      // Time formatƒ±nƒ± d√ºzelt (HH:MM:SS -> HH:MM)
      dersSaati: course.ders_saati ? course.ders_saati.substring(0, 5) : '',
      // Frontend ile uyumlu hale getir
      mainTitle: course.main_title,
      subtitle: course.subtitle,
      imageUrl: course.image_url,
      content: {
        egitimSuresi: [
          { "Ba≈ülangƒ±√ß": course.egitim_baslangic },
          { "Biti≈ü": course.egitim_bitis }
        ],
        mufredat: course.mufredat ? JSON.parse(course.mufredat) : []
      }
    }));

    res.json({ success: true, courses });
  } catch (error) {
    console.error('Admin kurslar hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Sunucu hatasƒ±' });
  }
});

// Kurs ba≈üvuru endpoint'i
app.post('/api/course-applications', async (req, res) => {
  try {
    const { courseId, name, email, phone, notes } = req.body;
    
    // Aynƒ± kurs i√ßin aynƒ± email veya telefon ile kayƒ±t var mƒ± kontrol et
    const [existingEmail] = await pool.execute(
      'SELECT id FROM course_applications WHERE course_id = ? AND student_email = ?',
      [courseId, email]
    );
    
    const [existingPhone] = await pool.execute(
      'SELECT id FROM course_applications WHERE course_id = ? AND student_phone = ?',
      [courseId, phone]
    );
    
    if (existingEmail.length > 0) {
      return res.status(400).json({
        success: false,
        message: 'Bu kurs i√ßin aynƒ± email adresi ile zaten ba≈üvuru yapƒ±lmƒ±≈ü.'
      });
    }
    
    if (existingPhone.length > 0) {
      return res.status(400).json({
        success: false,
        message: 'Bu kurs i√ßin aynƒ± telefon numarasƒ± ile zaten ba≈üvuru yapƒ±lmƒ±≈ü.'
      });
    }
    
    // Ba≈üvuruyu kaydet
    const [result] = await pool.execute(
      'INSERT INTO course_applications (course_id, name, email, phone, student_name, student_email, student_phone, message) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
      [courseId, name, email, phone, name, email, phone, notes || '']
    );
    
    // Kurs adƒ±nƒ± al ve aktivite kaydet
    const [courseData] = await pool.execute(
      'SELECT main_title FROM courses WHERE id = ?',
      [courseId]
    );
    
    if (courseData.length > 0) {
      await logStudentApplication(name, courseData[0].main_title);
    }
    
    res.json({
      success: true,
      message: 'Ba≈üvurunuz ba≈üarƒ±yla alƒ±ndƒ±!',
      applicationId: result.insertId
    });
    
  } catch (error) {
    console.error('Kurs ba≈üvuru hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Ba≈üvuru kaydedilirken bir hata olu≈ütu' 
    });
  }
});

// Kurs ba≈üvuru durumu g√ºncelleme endpoint'i
app.put('/api/course-applications/:id/status', async (req, res) => {
  try {
    const { id } = req.params;
    const { status } = req.body;
    
    // Ge√ßerli durum kontrol√º
    if (!['pending', 'approved', 'rejected'].includes(status)) {
      return res.status(400).json({
        success: false,
        message: 'Ge√ßersiz durum. Sadece pending, approved veya rejected kullanƒ±labilir.'
      });
    }
    
    // Durumu g√ºncelle
    const [result] = await pool.execute(
      'UPDATE course_applications SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?',
      [status, id]
    );
    
    if (result.affectedRows === 0) {
      return res.status(404).json({
        success: false,
        message: 'Ba≈üvuru bulunamadƒ±'
      });
    }
    
    res.json({
      success: true,
      message: 'Ba≈üvuru durumu ba≈üarƒ±yla g√ºncellendi'
    });
    
  } catch (error) {
    console.error('Durum g√ºncelleme hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Durum g√ºncellenirken bir hata olu≈ütu' 
    });
  }
});

// Kurs ba≈üvurularƒ±nƒ± getir endpoint'i
app.get('/api/course-applications', async (req, res) => {
  try {
    // √ñnce tablonun var olup olmadƒ±ƒüƒ±nƒ± kontrol et
    const [tableCheck] = await pool.execute("SHOW TABLES LIKE 'course_applications'");
    
    if (tableCheck.length === 0) {
      return res.json({
        success: true,
        applications: [],
        message: 'course_applications tablosu bulunamadƒ±'
      });
    }

    const [rows] = await pool.execute(`
      SELECT 
        ca.id,
        ca.course_id,
        ca.student_name as name,
        ca.student_email as email,
        ca.student_phone as phone,
        ca.message,
        ca.notes,
        ca.status,
        ca.created_at,
        ca.updated_at,
        c.main_title as course_name
      FROM course_applications ca
      INNER JOIN courses c ON ca.course_id = c.id
      WHERE c.is_active = 1
      ORDER BY ca.created_at DESC
    `);
    
    console.log('üìã ƒ∞lk ba≈üvuru verisi:', rows[0]);
    
    res.json({
      success: true,
      applications: rows
    });
  } catch (error) {
    console.error('Kurs ba≈üvurularƒ± hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Kurs ba≈üvurularƒ± y√ºklenirken bir hata olu≈ütu',
      error: error.message
    });
  }
});

// Banner'lar endpoint'i
app.get('/api/banners', async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT * FROM banners ORDER BY `order` ASC');
    res.json({ success: true, data: rows });
  } catch (error) {
    console.error('Banner hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Sunucu hatasƒ±' });
  }
});

// Admin - T√ºm kurslar (aktif/pasif fark etmez)
app.get('/api/admin/courses', async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT id, main_title, is_active, created_at, updated_at FROM courses ORDER BY created_at DESC');
    res.json({ success: true, courses: rows });
  } catch (error) {
    console.error('Admin kurslar hatasƒ±:', error);
    res.status(500).json({ success: false, message: 'Sunucu hatasƒ±' });
  }
});

// ƒ∞statistikler endpoint'i
app.get('/api/stats', async (req, res) => {
  try {
    // Onaylanmƒ±≈ü √∂ƒürenci sayƒ±sƒ± (benzersiz email)
    const [studentCount] = await pool.execute(`
      SELECT COUNT(DISTINCT student_email) as count 
      FROM course_applications 
      WHERE status = 'approved'
    `);
    
    // Ge√ßen ayki onaylanmƒ±≈ü √∂ƒürenci sayƒ±sƒ±
    const [lastMonthStudentCount] = await pool.execute(`
      SELECT COUNT(DISTINCT student_email) as count 
      FROM course_applications 
      WHERE status = 'approved' 
      AND created_at < DATE_SUB(NOW(), INTERVAL 1 MONTH)
    `);
    
    // √ñƒürenci b√ºy√ºme oranƒ±nƒ± hesapla
    const currentStudents = studentCount[0].count;
    const lastMonthStudents = lastMonthStudentCount[0].count;
    const studentGrowthRate = lastMonthStudents > 0 
      ? Math.round(((currentStudents - lastMonthStudents) / lastMonthStudents) * 100)
      : 0;
    
    // Toplam kurs sayƒ±sƒ± (aktif)
    const [courseCount] = await pool.execute(`
      SELECT COUNT(*) as count 
      FROM courses 
      WHERE is_active = 1
    `);
    
    // Toplam blog sayƒ±sƒ± (yayƒ±nlanmƒ±≈ü)
    const [blogCount] = await pool.execute(`
      SELECT COUNT(*) as count 
      FROM blogs 
      WHERE is_published = 1
    `);
    
    res.json({
      success: true,
      stats: {
        students: currentStudents,
        courses: courseCount[0].count,
        blogs: blogCount[0].count,
        studentGrowthRate: studentGrowthRate
      }
    });
    
  } catch (error) {
    console.error('ƒ∞statistikler hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: 'ƒ∞statistikler y√ºklenirken bir hata olu≈ütu' 
    });
  }
});

// Aktiviteler tablosunu olu≈ütur
async function createActivitiesTable() {
  try {
    await pool.execute(`
      CREATE TABLE IF NOT EXISTS activities (
        id INT AUTO_INCREMENT PRIMARY KEY,
        type ENUM('student', 'blog', 'blog_updated', 'course', 'course_created') NOT NULL,
        message TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        INDEX idx_type_created (type, created_at)
      )
    `);
    console.log('‚úÖ Activities tablosu hazƒ±r!');
  } catch (error) {
    console.error('Activities tablosu olu≈üturma hatasƒ±:', error);
  }
}

// Aktivite kaydetme fonksiyonlarƒ±
async function logStudentApplication(studentName, courseName) {
  try {
    await pool.execute(
      'INSERT INTO activities (type, message) VALUES (?, ?)',
      ['student', `Yeni √∂ƒürenci ba≈üvurusu: <strong>${studentName}</strong> - <strong>${courseName}</strong>`]
    );
  } catch (error) {
    console.error('√ñƒürenci ba≈üvuru aktivitesi kaydetme hatasƒ±:', error);
  }
}

async function logBlogPublished(blogTitle) {
  try {
    await pool.execute(
      'INSERT INTO activities (type, message) VALUES (?, ?)',
      ['blog', `Yeni blog yazƒ±sƒ± yayƒ±nlandƒ±: <strong>"${blogTitle}"</strong>`]
    );
  } catch (error) {
    console.error('Blog aktivitesi kaydetme hatasƒ±:', error);
  }
}

async function logBlogUpdated(blogTitle) {
  try {
    await pool.execute(
      'INSERT INTO activities (type, message) VALUES (?, ?)',
      ['blog_updated', `Blog yazƒ±sƒ± g√ºncellendi: <strong>"${blogTitle}"</strong>`]
    );
  } catch (error) {
    console.error('Blog g√ºncelleme aktivitesi kaydetme hatasƒ±:', error);
  }
}

async function logCourseUpdated(courseTitle) {
  try {
    await pool.execute(
      'INSERT INTO activities (type, message) VALUES (?, ?)',
      ['course', `Kurs g√ºncellendi: <strong>"${courseTitle}"</strong>`]
    );
  } catch (error) {
    console.error('Kurs g√ºncelleme aktivitesi kaydetme hatasƒ±:', error);
  }
}

async function logCourseCreated(courseTitle) {
  try {
    await pool.execute(
      'INSERT INTO activities (type, message) VALUES (?, ?)',
      ['course_created', `Yeni kurs olu≈üturuldu: <strong>"${courseTitle}"</strong>`]
    );
  } catch (error) {
    console.error('Kurs olu≈üturma aktivitesi kaydetme hatasƒ±:', error);
  }
}

async function logStudentStatusChange(studentEmail, status) {
  try {
    const statusText = status === 'approved' ? 'onaylandƒ±' : 
                      status === 'rejected' ? 'reddedildi' : 'beklemede';
    
    await pool.execute(
      'INSERT INTO activities (type, message) VALUES (?, ?)',
      ['student', `√ñƒürenci durumu g√ºncellendi: <strong>${studentEmail}</strong> - <strong>${statusText}</strong>`]
    );
  } catch (error) {
    console.error('√ñƒürenci durum deƒüi≈üikliƒüi aktivitesi kaydetme hatasƒ±:', error);
  }
}

// √ñƒürenci y√∂netimi endpoint'leri
app.get('/api/students', async (req, res) => {
  try {
    const { page = 1, limit = 10, search = '', status = 'all', course_id = 'all' } = req.query;
    const offset = (page - 1) * limit;
    
    let whereClause = 'WHERE ca.status = "approved"';
    let params = [];
    
    // Arama filtresi
    if (search) {
      whereClause += ' AND (ca.student_name LIKE ? OR ca.student_email LIKE ?)';
      params.push(`%${search}%`, `%${search}%`);
    }
    
    // Durum filtresi
    if (status !== 'all') {
      whereClause += ' AND ca.status = ?';
      params.push(status);
    }
    
    // Kurs filtresi
    if (course_id !== 'all') {
      whereClause += ' AND ca.course_id = ?';
      params.push(course_id);
    }
    
    // Toplam sayƒ±
    const [countResult] = await pool.execute(`
      SELECT COUNT(DISTINCT ca.student_email) as total
      FROM course_applications ca
      LEFT JOIN courses c ON ca.course_id = c.id
      ${whereClause}
    `, params);
    
    // √ñƒürenci listesi
    const [students] = await pool.execute(`
      SELECT 
        ca.student_name,
        ca.student_email,
        ca.student_phone,
        ca.created_at as first_application,
        ca.updated_at as last_updated,
        GROUP_CONCAT(DISTINCT c.main_title) as courses,
        GROUP_CONCAT(DISTINCT ca.status) as statuses,
        COUNT(DISTINCT ca.id) as total_applications
      FROM course_applications ca
      LEFT JOIN courses c ON ca.course_id = c.id
      ${whereClause}
      GROUP BY ca.student_email
      ORDER BY ca.created_at DESC
      LIMIT ? OFFSET ?
    `, [...params, parseInt(limit), offset]);
    
    res.json({
      success: true,
      students: students,
      pagination: {
        currentPage: parseInt(page),
        totalPages: Math.ceil(countResult[0].total / limit),
        totalStudents: countResult[0].total,
        hasNext: offset + students.length < countResult[0].total,
        hasPrev: page > 1
      }
    });
    
  } catch (error) {
    console.error('√ñƒürenci listesi hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: '√ñƒürenci listesi y√ºklenirken bir hata olu≈ütu' 
    });
  }
});

// Tek √∂ƒürenci detaylarƒ±
app.get('/api/students/:email', async (req, res) => {
  try {
    const { email } = req.params;
    
    const [studentDetails] = await pool.execute(`
      SELECT 
        ca.*,
        c.main_title as course_name,
        c.subtitle as course_subtitle
      FROM course_applications ca
      LEFT JOIN courses c ON ca.course_id = c.id
      WHERE ca.student_email = ? AND ca.status = 'approved'
      ORDER BY ca.created_at DESC
    `, [email]);
    
    if (studentDetails.length === 0) {
      return res.status(404).json({
        success: false,
        message: '√ñƒürenci bulunamadƒ±'
      });
    }
    
    // √ñƒürenci bilgilerini grupla
    const student = {
      name: studentDetails[0].student_name,
      email: studentDetails[0].student_email,
      phone: studentDetails[0].student_phone,
      firstApplication: studentDetails[0].created_at,
      lastUpdated: studentDetails[0].updated_at,
      applications: studentDetails.map(app => ({
        id: app.id,
        courseName: app.course_name,
        courseSubtitle: app.course_subtitle,
        status: app.status,
        message: app.message,
        appliedAt: app.created_at,
        updatedAt: app.updated_at
      }))
    };
    
    res.json({
      success: true,
      student: student
    });
    
  } catch (error) {
    console.error('√ñƒürenci detay hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: '√ñƒürenci detaylarƒ± y√ºklenirken bir hata olu≈ütu' 
    });
  }
});

// √ñƒürenci durumu g√ºncelleme
app.put('/api/students/:email/status', async (req, res) => {
  try {
    const { email } = req.params;
    const { status, note } = req.body;
    
    if (!['approved', 'rejected', 'pending'].includes(status)) {
      return res.status(400).json({
        success: false,
        message: 'Ge√ßersiz durum deƒüeri'
      });
    }
    
    await pool.execute(
      'UPDATE course_applications SET status = ?, updated_at = NOW() WHERE student_email = ?',
      [status, email]
    );
    
    // Aktivite kaydet
    await logStudentStatusChange(email, status);
    
    res.json({
      success: true,
      message: '√ñƒürenci durumu g√ºncellendi'
    });
    
  } catch (error) {
    console.error('√ñƒürenci durum g√ºncelleme hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: '√ñƒürenci durumu g√ºncellenirken bir hata olu≈ütu' 
    });
  }
});

// Son aktiviteler endpoint'i
app.get('/api/activities', async (req, res) => {
  try {
    // Aktiviteler tablosundan son 10 aktiviteyi √ßek
    const [activities] = await pool.execute(`
      SELECT 
        id,
        type,
        message,
        created_at
      FROM activities 
      ORDER BY created_at DESC 
      LIMIT 10
    `);
    
    const formattedActivities = activities.map(activity => {
      const timeAgo = getTimeAgo(activity.created_at);
      const iconMap = {
        'student': 'FaUsers',
        'blog': 'FaNewspaper',
        'blog_updated': 'FaNewspaper',
        'course': 'FaBook',
        'course_created': 'FaBook'
      };
      const colorMap = {
        'student': 'text-blue-500',
        'blog': 'text-green-500',
        'blog_updated': 'text-orange-500',
        'course': 'text-purple-500',
        'course_created': 'text-indigo-500'
      };
      const bgColorMap = {
        'student': 'bg-blue-50',
        'blog': 'bg-green-50',
        'blog_updated': 'bg-orange-50',
        'course': 'bg-purple-50',
        'course_created': 'bg-indigo-50'
      };
      
      return {
        id: activity.id,
        type: activity.type,
        message: activity.message,
        time: timeAgo,
        timestamp: new Date(activity.created_at),
        icon: iconMap[activity.type],
        color: colorMap[activity.type],
        bgColor: bgColorMap[activity.type]
      };
    });
    
    res.json({
      success: true,
      activities: formattedActivities
    });
    
  } catch (error) {
    console.error('Aktiviteler hatasƒ±:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Aktiviteler y√ºklenirken bir hata olu≈ütu' 
    });
  }
});

// Zaman hesaplama yardƒ±mcƒ± fonksiyonu
function getTimeAgo(dateString) {
  const now = new Date();
  const date = new Date(dateString);
  const diffInSeconds = Math.floor((now - date) / 1000);
  
  if (diffInSeconds < 60) {
    return 'Az √∂nce';
  } else if (diffInSeconds < 3600) {
    const minutes = Math.floor(diffInSeconds / 60);
    return `${minutes} dakika √∂nce`;
  } else if (diffInSeconds < 86400) {
    const hours = Math.floor(diffInSeconds / 3600);
    return `${hours} saat √∂nce`;
  } else {
    const days = Math.floor(diffInSeconds / 86400);
    return `${days} g√ºn √∂nce`;
  }
}

// Sunucuyu ba≈ülat
app.listen(PORT, async () => {
  console.log(`üöÄ Backend server √ßalƒ±≈üƒ±yor: http://localhost:${PORT}`);
  await testConnection();
});
